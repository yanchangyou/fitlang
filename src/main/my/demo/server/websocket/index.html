<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
</head>
<body>
<center>
    <h2>fit server (websocket demo)</h2>
    <br>
    <script type="text/javascript">
    var socket;
    function connectionWs() {
        if (!window.WebSocket) {
            window.WebSocket = window.MozWebSocket;
        }
        if (window.WebSocket) {
            socket = new WebSocket("ws://127.0.0.1:10000/test");
            socket.onmessage = function (event) {
                console.log("xxx" + event)
                var ta = document.getElementById('output');
                ta.value = event.data;
            };
            socket.onopen = function (event) {
                var ta = document.getElementById('output');
                ta.value ='{"message":"打开WebSocket服务正常，浏览器支持WebSocket!"}';
            };
            socket.onclose = function (event) {
                var ta = document.getElementById('output');
                ta.value ='{"message":"WebSocket 关闭!"}';
            }
        } else {
            alert("抱歉，您的浏览器不支持WebSocket协议!");
        }
    }

    function send(message) {
        if (!window.WebSocket) {
            return;
        }
        if (socket.readyState == WebSocket.OPEN) {
            socket.send(message);
        }else {
            alert("WebSocket连接没有建立成功!");
        }
    }

    var request = new XMLHttpRequest();

    function start() {
        var url = "websocketserver.fit";
        request.open("GET", url, true);
        request.onreadystatechange = function(message) {
            if (request.readyState == 4 && request.status == 200) {
                alert(request.responseText);
                connectionWs();
            }
        };
        request.send(null);
    }

    function format() {
       formatText('input');
       formatText('output');
    }
    
    function formatText(domId) {
        var inputText = document.getElementById(domId).value;
        document.getElementById(domId).value = JSON.stringify(JSON.parse(inputText), 2,' ');
    }

    </script>

    <form onsubmit="return false;">
        <h3>输入代码</h3>
        <textarea type="text" id="input" name="message" style="width:700px; height: 200px;">{"uni":"hello","message":"hello websocket!"}</textarea>
        <br/><br/>
        <input type="button" value="启动websocket" onclick="start()">
        <input type="button" value="发送执行" onclick="send(this.form.message.value)">
        <input type="button" value="格式化" onclick="format()">
        &nbsp;&nbsp; <a target="_blank" href="/_menu">api</a><br/><br/>
        <h3>输出结果</h3>
        <textarea id="output" style="width:700px; height: 200px;">{}</textarea>
    </form>

</center>
</body>
</html>